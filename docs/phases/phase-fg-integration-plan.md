# Phase F+G Integration Plan — Rules Engine + Calendar

## Overview

**Goal:** Wire existing rules engine and calendar code to the main UI for automatic mode selection.

**Key Discovery:** Both systems are fully implemented but disconnected from `page.tsx`. This is an integration task, not a development task.

---

## Current State

### Rules Engine (`src/rules/`)
| File | Status | Purpose |
|------|--------|---------|
| `rules-engine.ts` | ✅ Complete | Main engine class with `evaluateContext()` |
| `context-engine.ts` | ✅ Complete | Computes meeting proximity/context |
| `mode-selector.ts` | ✅ Complete | Selects mode based on context |
| `stability.ts` | ✅ Complete | Prevents rapid mode switching |
| `capsule-generator.ts` | ✅ Complete | Generates decision capsule explanations |
| `use-rules-engine.ts` | ✅ Complete | React hook for components |

### Calendar (`src/calendar/`)
| File | Status | Purpose |
|------|--------|---------|
| `oauth.ts` | ✅ Complete | Google OAuth PKCE flow |
| `api.ts` | ✅ Complete | Calendar API client with iCalUID |
| `cache.ts` | ✅ Complete | Snapshot caching (5-min TTL) |
| `use-calendar.ts` | ✅ Complete | React hook + `useCalendarForRules()` adapter |
| `types.ts` | ✅ Complete | Type definitions |

### Main UI (`src/app/page.tsx`)
| Current Behavior | Issue |
|-----------------|-------|
| Uses `staticPlans[currentMode]` | Mode set manually, not by rules |
| Manual mode buttons | No automatic switching |
| No calendar data | Uses test scenarios only |
| `staticCapsules[currentMode]` | Not generated by rules engine |

---

## Integration Steps

### Step 1: Add Calendar Login Button

**Location:** `src/app/page.tsx`

**Change:**
- Add a "Connect Calendar" button when not authenticated
- Show calendar status indicator when connected
- Use existing `useCalendar()` hook

**Implementation:**
```tsx
const { isAuthenticated, signIn, signOut, isLoading } = useCalendar();

// In render:
{!isAuthenticated ? (
  <button onClick={signIn}>Connect Google Calendar</button>
) : (
  <span className="text-green-600">Calendar Connected</span>
)}
```

---

### Step 2: Connect Calendar Events to Rules Engine

**Location:** `src/app/page.tsx`

**Change:**
- Import `useCalendarForRules()` to get events in rules format
- Pass events to rules engine evaluation
- Trigger evaluation on `app_open` and when events change

**Implementation:**
```tsx
const { events: calendarEvents, isReady } = useCalendarForRules();
const { currentMode, capsule, evaluate, forceMode } = useRulesEngine({
  events: calendarEvents,
  initialMode: 'neutral_intent',
});

// Trigger on mount
useEffect(() => {
  if (isReady) {
    evaluate('app_open');
  }
}, [isReady, evaluate]);
```

---

### Step 3: Enable Automatic Mode Selection

**Location:** `src/app/page.tsx`

**Change:**
- Replace manual mode state with rules engine state
- Use dynamic capsules from rules engine instead of static
- Set up timer for periodic re-evaluation (meeting boundary checks)

**Implementation:**
```tsx
// Replace:
const plan = staticPlans[currentMode];
const capsule = staticCapsules[currentMode];

// With:
const { currentMode, plan, capsule, evaluate } = useRulesEngine({...});

// Add periodic evaluation for meeting boundaries
useEffect(() => {
  const interval = setInterval(() => {
    evaluate('meeting_boundary_change');
  }, 60_000); // Every minute
  return () => clearInterval(interval);
}, [evaluate]);
```

---

### Step 4: Preserve Manual Override Behavior

**Location:** `src/app/page.tsx`

**Change:**
- Keep mode buttons functional via `forceMode()`
- Log overrides to storage for founder test metrics
- Rules engine already handles override detection

**Implementation:**
```tsx
const handleModeChange = async (newMode: Mode) => {
  // Use forceMode instead of setCurrentMode
  await forceMode(newMode);
  recordInteraction(INTERACTION_TYPES.MODE_SWITCH);
};
```

---

### Step 5: Handle Offline/Unauthenticated State

**Location:** `src/app/page.tsx`

**Behavior:**
- When calendar is not connected: Use static plans (current behavior)
- When calendar errors: Fall back to static plans, show warning
- Always allow manual mode switching

**Implementation:**
```tsx
const useFallbackMode = !isAuthenticated || calendarError;

// Get plan from rules or static fallback
const activePlan = useFallbackMode
  ? staticPlans[currentMode]
  : plan ?? staticPlans[currentMode];
```

---

### Step 6: Wire OAuth Callback

**Location:** `src/app/auth/callback/page.tsx` (exists but needs verification)

**Verify:**
- OAuth callback properly stores tokens
- Redirects back to main app
- Triggers calendar refresh

---

## Files to Modify

| File | Changes |
|------|---------|
| `src/app/page.tsx` | Main integration point - hooks, evaluation triggers |
| `src/components/calendar/CalendarStatus.tsx` | New - status indicator + login button |
| `src/app/auth/callback/page.tsx` | Verify OAuth callback completion |

---

## Testing Plan

### Manual Testing
1. **No calendar**: App loads in neutral mode, manual switching works
2. **Connect calendar**: OAuth flow completes, events load
3. **Upcoming meeting**: Mode auto-switches to prep 45 min before
4. **Active meeting**: Mode auto-switches to capture at start time
5. **Post meeting**: Mode auto-switches to synthesis after end
6. **Manual override**: User can switch modes, persists until boundary

### E2E Tests
- Add new test file: `calendar-integration.spec.ts`
- Test OAuth mock flow
- Test mode selection with simulated calendar events

---

## Done Criteria

- [ ] Calendar login button visible on main page
- [ ] OAuth flow completes and stores tokens
- [ ] Calendar events appear in app (can verify via DevHarness)
- [ ] Mode automatically changes based on meeting proximity
- [ ] Decision capsule shows real context (not static text)
- [ ] Manual override still works
- [ ] Fallback to static mode when calendar unavailable
- [ ] All 119 E2E tests still pass

---

## Risk Analysis

| Risk | Mitigation |
|------|------------|
| OAuth requires HTTPS | Use `localhost` exception or test with mock |
| API rate limits | Cache with 5-min TTL (already implemented) |
| Mode switching jank | Stability rules prevent switching during input |
| Calendar permission denied | Show clear error, fall back to static |

---

## Time Estimate

This is an **integration task**, not a development task. All logic exists:
- Rules engine: ~280 lines, fully tested
- Calendar: ~300 lines, OAuth complete
- Integration: ~50-100 lines in page.tsx

**Scope:** Wire 3 hooks together, add login UI, test.
